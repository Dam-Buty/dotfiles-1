#!/bin/bash

set -euxo pipefail

NO_PULL=${NO_PULL:-0}

function plop () {
  notify-send -u critical -i ~/dotfiles/assets/rick.png Hey\! "$1"
}

if ! systemctl is-active docker --quiet ; then
  sudo systemctl start docker
fi

function pullIfNeeded() {
  if [[ "$NO_PULL" != "1" ]]; then
    docker-compose pull
  fi
}

cd /home/meri/.vault/vault-integration

(
  (
    stop-vault && \
    pullIfNeeded && \
    hsmaas init --compartment-id "$VAULT_COMPARTMENT_ID" --clean && \
    docker-compose up -d
  ) && \
  plop "Vault has been reset"
) || plop "Failed to reset"
