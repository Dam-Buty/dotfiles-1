#!/bin/bash

set -e

cd ~/ledger/vault-integration
git pull origin master
docker-compose down --remove-orphans
docker-compose pull
docker-compose up -d

cd ~/ledger/ledger-vault-hsm-driver
git pull origin develop-drop2
# shellcheck disable=SC1091
source venv/bin/activate
python3 hsmaas.py init --compartment-id "$VAULT_COMPARTMENT_ID" --clean

cd ~/ledger/ledger-vault-api
git pull origin develop-drop2
cd ~/ledger/ledger-vault-api/tests/integration
# shellcheck disable=SC1091
source venv/bin/activate

while true; do
  if curl http://localhost:5000/ledger1/_health &>/dev/null ; then
    break
  fi
  sleep 1
done

python test_onboarding.py

notify-send -u critical "Onboarding finished ðŸ‘Œ" "Vault ready to go! ðŸš€"
